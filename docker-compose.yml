services:
  redis:
    image: redis/redis-stack:7.2.0-v10
    ports:
      - "6380:6379"   # host 6380 to avoid conflict with existing Redis on 6379
      - "8002:8001"   # Redis Insight UI
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  ingestor:
    build:
      context: ./ingestor
      dockerfile: Dockerfile
    environment:
      REDIS_ADDR: redis:6379
      POLL_INTERVAL: 60s
    depends_on:
      redis:
        condition: service_healthy

  collector:
    build:
      context: ./collector
      dockerfile: Dockerfile
    environment:
      REDIS_ADDR: redis:6379
      COLLECTOR_INTERVAL: 6h
    depends_on:
      redis:
        condition: service_healthy

  predictor:
    build:
      context: ./predictor
      dockerfile: Dockerfile
    environment:
      REDIS_ADDR: redis:6379
      # Optional: set in .env to show anytime goal scorer odds in /nextgame and reminders
      ODDS_API_KEY: ${ODDS_API_KEY:-}
    depends_on:
      redis:
        condition: service_healthy

  announcer:
    build:
      context: ./announcer
      dockerfile: Dockerfile
    environment:
      REDIS_ADDR: redis:6379
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      DISCORD_ANNOUNCE_CHANNEL_ID: ${DISCORD_ANNOUNCE_CHANNEL_ID:-}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID:-}
    depends_on:
      redis:
        condition: service_healthy

  # Runs every 30m; after each completed Caps game publishes post-game summary to ovechkin:post_game; announcer posts to Discord.
  evaluator:
    build:
      context: ./evaluator
      dockerfile: Dockerfile
    environment:
      REDIS_ADDR: redis:6379
    depends_on:
      redis:
        condition: service_healthy
